{% extends "base.html" %} {% block title %}{{ course.title }} - Learning -
AgriConnect{% endblock %} {% block content %}
<div class="container-fluid py-4">
  <!-- Course Header -->
  <div class="row mb-4">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="{{ url_for('learning.index') }}">Learning Hub</a>
          </li>
          <li class="breadcrumb-item">
            <a
              href="{{ url_for('learning.course_detail', course_id=course.id) }}"
              >{{ course.title }}</a
            >
          </li>
          <li class="breadcrumb-item active">Learning</li>
        </ol>
      </nav>
    </div>
  </div>

  <div class="row">
    <!-- Course Content -->
    <div class="col-lg-8">
      <!-- Current Module -->
      {% if current_module %}
      <div class="card mb-4">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0">{{ current_module.title }}</h5>
          <span
            class="badge bg-{{ 'primary' if current_module.content_type == 'video' else 'info' if current_module.content_type == 'text' else 'warning' if current_module.content_type == 'quiz' else 'success' }}"
          >
            {{ current_module.content_type.title() }}
          </span>
        </div>
        <div class="card-body">
          {% if current_module.description %}
          <p class="text-muted mb-3">{{ current_module.description }}</p>
          {% endif %}

          <!-- Module Content -->
          {% if current_module.content_type == 'video' and
          current_module.content %}
          <div class="mb-4">
            <div class="ratio ratio-16x9">
              <iframe
                src="{{ current_module.content }}"
                allowfullscreen
              ></iframe>
            </div>
          </div>
          {% elif current_module.content_type == 'text' and
          current_module.content %}
          <div class="mb-4">
            <div class="bg-light p-4 rounded">
              {{ current_module.content|safe }}
            </div>
          </div>
          {% elif current_module.content_type == 'quiz' %}
          <div class="alert alert-info">
            <i class="fas fa-question-circle me-2"></i>
            <strong>Quiz Module:</strong> Complete the quiz below to proceed to
            the next module.
          </div>
          <div class="bg-light p-4 rounded">
            {{ current_module.content|safe }}
          </div>
          {% elif current_module.content_type == 'assignment' %}
          <div class="alert alert-warning">
            <i class="fas fa-tasks me-2"></i>
            <strong>Assignment Module:</strong> Complete the assignment below
            and submit your work.
          </div>
          <div class="bg-light p-4 rounded">
            {{ current_module.content|safe }}
          </div>
          {% endif %}

          <!-- Module Actions -->
          <div class="d-flex justify-content-between align-items-center">
            <div>
              {% if progress and progress.is_completed %}
              <span class="badge bg-success">
                <i class="fas fa-check-circle me-1"></i>Completed
              </span>
              {% else %}
              <span class="badge bg-secondary">
                <i class="fas fa-clock me-1"></i>In Progress
              </span>
              {% endif %}
            </div>
            <div>
              {% if not (progress and progress.is_completed) %}
              <button
                class="btn btn-success"
                onclick="completeModule({{ current_module.id }})"
              >
                <i class="fas fa-check me-1"></i>Mark as Complete
              </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% else %}
      <div class="card mb-4">
        <div class="card-body text-center py-5">
          <i class="fas fa-graduation-cap fa-3x text-muted mb-3"></i>
          <h4>No modules available</h4>
          <p class="text-muted">This course doesn't have any modules yet.</p>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <!-- Course Progress -->
      <div class="card mb-4">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="fas fa-chart-line me-2"></i>Course Progress
          </h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span>Overall Progress</span>
              <span
                >{{ "%.0f"|format(enrollment.get_progress_percentage())
                }}%</span
              >
            </div>
            <div class="progress" style="height: 8px">
              <div
                class="progress-bar"
                role="progressbar"
                style="width: {{ enrollment.get_progress_percentage() }}%"
                aria-valuenow="{{ enrollment.get_progress_percentage() }}"
                aria-valuemin="0"
                aria-valuemax="100"
              ></div>
            </div>
          </div>

          <div class="row text-center">
            <div class="col-6">
              <h6 class="text-primary">{{ modules|length }}</h6>
              <small class="text-muted">Total Modules</small>
            </div>
            <div class="col-6">
              <h6 class="text-success">
                {% set completed_count = 0 %} {% for module in modules %} {% for
                progress_item in enrollment.progress %} {% if
                progress_item.module_id == module.id and
                progress_item.is_completed %} {% set completed_count =
                completed_count + 1 %} {% endif %} {% endfor %} {% endfor %} {{
                completed_count }}
              </h6>
              <small class="text-muted">Completed</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Course Modules List -->
      <div class="card mb-4">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-list me-2"></i>Course Modules</h6>
        </div>
        <div class="card-body p-0">
          {% if modules %}
          <div class="list-group list-group-flush">
            {% for module in modules %}
            <a
              href="{{ url_for('learning.learn_course', course_id=course.id, module=module.id) }}"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {{ 'active' if current_module and current_module.id == module.id else '' }}"
            >
              <div class="d-flex align-items-center">
                <div class="me-3">
                  {% if module.content_type == 'video' %}
                  <i class="fas fa-play-circle text-primary"></i>
                  {% elif module.content_type == 'text' %}
                  <i class="fas fa-file-text text-info"></i>
                  {% elif module.content_type == 'quiz' %}
                  <i class="fas fa-question-circle text-warning"></i>
                  {% elif module.content_type == 'assignment' %}
                  <i class="fas fa-tasks text-success"></i>
                  {% endif %}
                </div>
                <div>
                  <h6 class="mb-1">{{ module.title }}</h6>
                  {% if module.duration_minutes > 0 %}
                  <small class="text-muted">
                    <i class="fas fa-clock me-1"></i>{{ module.duration_minutes
                    }} min
                  </small>
                  {% endif %}
                </div>
              </div>
              <div>
                {% set module_completed = false %} {% for progress_item in
                enrollment.progress %} {% if progress_item.module_id ==
                module.id and progress_item.is_completed %} {% set
                module_completed = true %} {% endif %} {% endfor %} {% if
                module_completed %}
                <i class="fas fa-check-circle text-success"></i>
                {% elif current_module and current_module.id == module.id %}
                <i class="fas fa-play text-primary"></i>
                {% else %}
                <i class="fas fa-circle text-muted"></i>
                {% endif %}
              </div>
            </a>
            {% endfor %}
          </div>
          {% else %}
          <div class="p-3 text-center">
            <i class="fas fa-list fa-2x text-muted mb-2"></i>
            <p class="text-muted mb-0">No modules available</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Course Info -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>Course Information
          </h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <strong>Instructor:</strong><br />
            <span class="text-muted"
              >{{ course.instructor.get_full_name() }}</span
            >
          </div>

          <div class="mb-3">
            <strong>Duration:</strong><br />
            <span class="text-muted">{{ course.duration_hours }} hours</span>
          </div>

          <div class="mb-3">
            <strong>Difficulty:</strong><br />
            <span
              class="badge bg-{{ 'success' if course.difficulty_level == 'beginner' else 'warning' if course.difficulty_level == 'intermediate' else 'danger' }}"
            >
              {{ course.difficulty_level.title() }}
            </span>
          </div>

          <div class="mb-3">
            <strong>Language:</strong><br />
            <span class="text-muted">
              {% if course.language == 'en' %}English {% elif course.language ==
              'ar' %}Arabic {% elif course.language == 'fr' %}French {% endif %}
            </span>
          </div>

          <div class="d-grid gap-2">
            <a
              href="{{ url_for('learning.course_detail', course_id=course.id) }}"
              class="btn btn-outline-primary btn-sm"
            >
              <i class="fas fa-info-circle me-1"></i>Course Details
            </a>
            <a
              href="{{ url_for('learning.my_courses') }}"
              class="btn btn-outline-secondary btn-sm"
            >
              <i class="fas fa-list me-1"></i>My Courses
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function completeModule(moduleId) {
    fetch(`/learning/course/{{ course.id }}/module/${moduleId}/complete`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          location.reload();
        } else {
          alert("Error completing module");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Error completing module");
      });
  }
</script>
{% endblock %}

